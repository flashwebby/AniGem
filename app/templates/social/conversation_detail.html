{% extends 'base.html' %}

{% block title %}Conversation with {{ other_user.username }}{% endblock %}

{% block header %}
  <h1>Conversation with <a href="{{ url_for('user.profile', username=other_user.username) }}">{{ other_user.username }}</a></h1>
{% endblock %}

{% block content %}
<style>
  .messages-container { 
    max-height: 500px; /* Or desired height */
    overflow-y: auto; 
    padding: 10px; 
    border: 1px solid #eee; 
    margin-bottom: 20px; 
    background-color: #f9f9f9;
    display: flex;
    flex-direction: column; /* Stack messages */
  }
  .message-item { 
    padding: 8px 12px; 
    border-radius: 15px; 
    margin-bottom: 8px; 
    max-width: 70%;
    word-wrap: break-word;
  }
  .message-item.sent { 
    background-color: #007bff; 
    color: white; 
    align-self: flex-end; /* Align sent messages to the right */
    border-bottom-right-radius: 5px;
  }
  .message-item.received { 
    background-color: #e9ecef; 
    color: #333; 
    align-self: flex-start; /* Align received messages to the left */
    border-bottom-left-radius: 5px;
  }
  .message-timestamp { font-size: 0.75em; color: #777; margin-top: 3px; display: block; }
  .message-item.sent .message-timestamp { text-align: right; color: #f0f0f0; }
  .message-item.received .message-timestamp { text-align: left; }
  
  .message-form textarea { 
    width: calc(100% - 22px); 
    padding: 10px; 
    border: 1px solid #ccc; 
    border-radius: 4px; 
    margin-bottom: 10px; 
    resize: vertical;
  }
  .message-form input[type="submit"] { 
    padding: 10px 15px; 
    background-color: #007bff; 
    color: white; border: none; 
    border-radius: 4px; cursor: pointer; 
  }
  .message-form input[type="submit"]:hover { background-color: #0056b3; }
</style>

<div class="messages-container" id="messages-container">
  {% if messages %}
    {% for msg in messages %}
      <div class="message-item {% if msg.sender_id == g.user.id %}sent{% else %}received{% endif %}">
        <p>{{ msg.message_content }}</p>
        <span class="message-timestamp">{{ msg.sent_at.strftime('%Y-%m-%d %H:%M') }}</span>
      </div>
    {% endfor %}
  {% else %}
    <p>No messages yet in this conversation. Start by sending one below.</p>
  {% endif %}
</div>

<form action="{{ url_for('social.send_dm_route', receiver_id=other_user.id) }}" method="post" class="message-form">
  <div>
    <textarea name="message_content" rows="3" placeholder="Type your message..." required></textarea>
  </div>
  <input type="submit" value="Send Message">
</form>

<script>
  // Scroll to the bottom of the messages container on page load
  document.addEventListener('DOMContentLoaded', function() {
    var messagesContainer = document.getElementById('messages-container');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });
</script>
{% endblock %}
